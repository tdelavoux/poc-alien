var P=Object.defineProperty;var E=(a,t,e)=>t in a?P(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var I=(a,t,e)=>E(a,typeof t!="symbol"?t+"":t,e);class M{static stringToHtmlElement(t){const e=document.createElement("div");return e.innerHTML=t,e.firstChild}}let b=null;async function k(){if(b)return b;const a=await R(),t=`/modules/${a.id}/templates/`;return b={moduleId:a.id,moduleTitle:a.title,templatePath:t},b}async function R(){const a=new URL("../module.json",import.meta.url).href,t=await fetch(a);if(!t.ok)throw new Error(`Failed to load module.json: ${t.statusText}`);return await t.json()}async function L(){const a=await k();game.settings.register(a.moduleId,"hostile",{name:"Hostile Tokens",hint:"Unable or disable hostile tokens",scope:"world",config:!0,type:Boolean,default:!1})}class g{constructor(t){if(this.token=t,!this.tokenIsValidActor())throw new Error("Token is not a suitable actor")}getSkill(t){var e,s,o,n,i;return(s=(e=this.token.actor)==null?void 0:e.system)!=null&&s.skills[t]||console.error(`Skill ${attributeName} not found`),((i=(n=(o=this.token.actor)==null?void 0:o.system)==null?void 0:n.skills[t])==null?void 0:i.value)??0}getAttribute(t){var e,s,o,n,i;return(s=(e=this.token.actor)==null?void 0:e.system)!=null&&s.attributes[t]||console.error(`Attribute ${t} not found`),((i=(n=(o=this.token.actor)==null?void 0:o.system)==null?void 0:n.attributes[t])==null?void 0:i.value)??0}getStressValue(){return this.token.actor.system.header.stress.value}getPanicValue(){var t,e,s,o,n,i;return((s=(e=(t=this.token.actor.system)==null?void 0:t.general)==null?void 0:e.panic)==null?void 0:s.value)===1?(i=(n=(o=this.token.actor.system)==null?void 0:o.general)==null?void 0:n.panic)==null?void 0:i.lastRoll:0}getLastPanicMessage(){return this.token.actor.morePanic(this.getPanicValue())}getId(){return this.token.id}getName(){return this.token.name}getActor(){return this.token.actor}getOwners(t=!1){var e;return(e=game==null?void 0:game.users)==null?void 0:e.filter(s=>s.character===this.token.actor&&(t?s.active:!0))}tokenIsValidActor(){return!!this.token&&!!this.token.actor}static getTokenFromId(t){const e=canvas.tokens.get(t);return new this(e)}static getTokenFromActorId(t){const e=canvas.tokens.placeables.find(s=>{var o;return((o=s.actor)==null?void 0:o.id)===t});return new this(e)}static async getPlayersFromList(t){const e=await k(),s=[CONST.TOKEN_DISPOSITIONS.FRIENDLY,game.settings.get(e.moduleId,"hostile")?CONST.TOKEN_DISPOSITIONS.HOSTILE:null].filter(Boolean);try{return t.filter(o=>{var n;return((n=o.actor)==null?void 0:n.type)==="character"&&s.includes(o.document.disposition)})}catch{return console.error("Not a suitable list of tokens"),{}}}}class h{static async create(t){await ChatMessage.create(t)}static deleteMessage(t,e=!1){!t||!t instanceof ChatMessage||(this.isUserMessageOwner(t)?h.deleteMessageFromDb(t):e&&game.socket.emit("module.roll-request",{action:"delete-roll-request",messageId:t.id}))}static deleteMessageFromDb(t){!t||!this.isUserMessageOwner(t)||t==null||t.delete()}static cleanChatMessageByClassName(t="message"){document.querySelectorAll(`.chat-message:has(.${t})`).forEach(e=>{const s=ChatMessage.get(e.dataset.messageId);h.deleteMessage(s)})}static isUserMessageOwner(t){return!t||!t instanceof ChatMessage,t.testUserPermission(game.user,CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER)}static setMessageCreationListener(t){game.socket.on("module.roll-request",e=>{if(e.action==="delete-roll-request"){const s=ChatMessage.get(e.messageId);h.deleteMessage(s)}}),Hooks.on("createChatMessage",e=>{var s,o,n,i;if(e.isRoll&&((n=(o=(s=e.rolls[0])==null?void 0:s.terms[0])==null?void 0:o.constructor)==null?void 0:n.name)==="AlienRPGBaseDie"){const r=M.stringToHtmlElement(e.content),l=g.getTokenFromActorId(r==null?void 0:r.dataset.actorId)??g.getTokenFromId((i=e.speaker)==null?void 0:i.token);setTimeout(()=>{e.update({speaker:{alias:l.getName()}})},100);const c=e.rolls[0];c&&l&&t.logRollResult(l,c)}Hooks.on("updateActor",(r,l,c,m)=>{var u,p;if((p=(u=l.system)==null?void 0:u.general)!=null&&p.panic){const d=g.getTokenFromActorId(r.id);t.syncPanic(d)}})})}static setCommonListeners(){Hooks.on("renderChatMessage",(t,e,s)=>{var o;(o=e.find(".rollable"))==null||o.on("click",n=>{var c;const r=n.currentTarget.dataset,l=g.getTokenFromId(r==null?void 0:r.token).token;(c=l==null?void 0:l.actor)==null||c.rollAbility(l==null?void 0:l.actor,r),h.deleteMessage(t,!0)})})}}const A="/systems/alienrpg/template.json";let T=null;async function N(){if(T)return T;const a=await S();return T={attributes:a.Actor.character.attributes,skills:a.Actor.character.skills},T}async function S(){const a=new URL(A,import.meta.url).href,t=await fetch(a);if(!t.ok)throw new Error(`Failed to load alien template.json: ${t.statusText}`);return await t.json()}const y=class y{constructor(t,e,s,o=!1){this.token=t,this.type=e,this.key=s,this.isPush=o,this.rollName="randomRoll",this.diceNumber=0,this.template="rollRequest.html"}async createRollNotification(t=[]){await this.determineDicesForRoll();const s=`${(await k()).templatePath}${this.template}`,o=await renderTemplate(s,{tokenId:this.token.getId(),tokenName:this.token.getName(),label:this.rollName,number:this.diceNumber}),n={whisper:t,type:CONST.CHAT_MESSAGE_STYLES.OTHER,content:o,flags:{GmRollRequest:{interactiveButton:!0,rollType:this.key}}};await h.create(n)}async determineDicesForRoll(){var e,s,o;const t=await N();switch(this.type){case y.RollTypeEnum.skill:const n=(e=t==null?void 0:t.skills[this.key])==null?void 0:e.ability;this.diceNumber=this.token.getSkill(this.key)+this.token.getAttribute(n),this.rollName=((s=t==null?void 0:t.skills[this.key])==null?void 0:s.label)??"undefined roll";break;case y.RollTypeEnum.attribute:this.diceNumber=this.token.getAttribute(this.key),this.rollName=((o=t==null?void 0:t.attributes[this.key])==null?void 0:o.label)??"undefined roll";break}}async characterRoll(){await this.determineDicesForRoll(),await game.alienrpg.yze.yzeRoll("character",!1,this.isPush,this.rollName,this.diceNumber,game.i18n.localize("ALIENRPG.Black"),this.token.getStressValue(),game.i18n.localize("ALIENRPG.Yellow"),this.token.getActor().id,"randomStringValue",1,null)}};I(y,"RollTypeEnum",{skill:"skill",attribute:"attribute"});let f=y;class F{static getDicesFromRoll(t){let e=0,s=0;return t==null||t.terms.forEach((o,n)=>{Array.isArray(o==null?void 0:o.results)&&(e+=o.results.filter(i=>i.result===6).length,s+=n!==0?o.results.filter(i=>i.result===1).length:0)}),{success:e,stress:s}}}class v{constructor(t){var e;if(!t){console.warn("Trigger is not a valid HTML element. Module cannot be set");return}this.trigger=t,this.rootNode=null,this.template="modale.html",this.templateRollLigne="roll-line.html",this.templatePanic="panic-line.html",(e=this.trigger)==null||e.addEventListener("click",()=>this.toggle())}async create(){const t=this,e=await k(),s=await N(),o=`${e.templatePath}${this.template}`,n=await g.getPlayersFromList(canvas.tokens.placeables),i=s.skills,r=s.attributes,l=await renderTemplate(o,{tokens:n,skills:i,attributes:r}),c=new Dialog({title:`${e.moduleId} - ${e.moduleTitle}`,content:l,buttons:{},render:m=>{let u=m==null?void 0:m.closest(".dialog");if(!u.find(".header-button.minimize")){let p=u==null?void 0:u.find(".window-header .close"),d=$('<a class="header-button control minimize">Minimize</a>');d==null||d.on("click",()=>{var w;return(w=t.rootNode)==null?void 0:w.minimize()}),p.before(d)}t.applyFormListeners(m),this.syncPanic(...n)},close:()=>{t.rootNode=null}},{width:600});c.render(!0),t.rootNode=c}toggle(){if(!this.rootNode){this.create();return}this.rootNode.close()}async update(){var l;if(!this.rootNode)return;const t=await k(),e=await N(),s=`${t.templatePath}${this.template}`,o=await g.getPlayersFromList(canvas.tokens.placeables),n=e.skills,i=e.attributes,r=await renderTemplate(s,{tokens:o,skills:n,attributes:i});this.rootNode.data.content=r,(l=this.rootNode)==null||l.render(!0)}applyFormListeners(t){document.getElementById("rollDice").addEventListener("click",()=>{this.formAction()}),t.find(".attribute-item input").on("change",function(){this.checked&&t.find(".skill-item input").prop("checked",!1)}),t.find(".skill-item input").on("change",function(){this.checked&&t.find(".attribute-item input").prop("checked",!1)}),document.getElementById("cleanup-pending-requests").addEventListener("click",()=>{h.cleanChatMessageByClassName("alien-request-roll"),ui.notifications.warn("Pending Notifications has been cleared")}),document.getElementById("update-modal-content").addEventListener("click",()=>{this.update()})}formAction(){var l,c;const t=Array.from(document.querySelectorAll("#tokenList input:checked")).map(m=>m.value),e=document.querySelector(".attribute-item input:checked"),s=document.querySelector(".skill-item input:checked"),o=e?f.RollTypeEnum.attribute:f.RollTypeEnum.skill,n=e?e==null?void 0:e.value:s==null?void 0:s.value,i=(l=document.querySelector("#rollForMissing:checked"))==null?void 0:l.checked,r=(c=document.querySelector("#forceForPresents:checked"))==null?void 0:c.checked;if(t.length<1||!n){ui.notifications.warn("You need to select at least a token and a skill or attribute");return}t.forEach(m=>{const u=g.getTokenFromId(m);if(!u)return;const p=new f(u,o,n),d=u.getOwners(!0);(d.length===0?i:r)?p.characterRoll():p.createRollNotification(d==null?void 0:d.map(w=>w.id))})}async logRollResult(t,e){const s=document.querySelector(`#token-item-${t.getId()} .last-roll-result`);if(!s)return;const n=`${(await k()).templatePath}${this.templateRollLigne}`,i=F.getDicesFromRoll(e),r=await renderTemplate(n,{token:t.token,roll:i});s.innerHTML=r,await this.syncPanic(t)}async syncPanic(...t){const e=await k();[...t].forEach(async s=>{s=s instanceof g?s:g.getTokenFromId((s==null?void 0:s.id)??s);const o=document.querySelector(`#token-item-${s.getId()} .panic-state`);if(!o)return;const n={isPanic:s.getPanicValue(),panicMessage:s.getLastPanicMessage()},i=`${e.templatePath}${this.templatePanic}`,r=await renderTemplate(i,{token:s.token,panic:n});o.innerHTML=r})}}Hooks.once("ready",async()=>{if(await k(),game.user.isGM){const a=new v(document.querySelector("#chat-controls .chat-control-icon"));h.cleanChatMessageByClassName("alien-request-roll"),h.setMessageCreationListener(a),Hooks.on("createToken",t=>{a.update()}),Hooks.on("deleteToken",t=>{a.update()})}h.setCommonListeners()});Hooks.once("init",async()=>{await L()});
